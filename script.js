// ===== MOVIES DATA - This will be updated when you save the project =====
let movies = [
  {
    "id": 1759858051781,
    "type": "folder",
    "title": "From",
    "description": "From Horror Movie Series",
    "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
    "category": "series",
    "children": [
      {
        "id": 1759858184851,
        "type": "folder",
        "title": " Season 1",
        "description": "Horror Movie Series",
        "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
        "category": "series",
        "children": [],
        "episodes": [
          {
            "id": 1759882051480,
            "title": "From EP01",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/vtc0mq9gf36m3at60roco/From_480P_S01_EP01.mp4?rlkey=s3noac0vwgpqa3eg8h54h1b60&st=v3lfb5cp&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          },
          {
            "id": 1759882077595,
            "title": "From EP02",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/kil94s6fie8ft06myk4th/From_480P_S01_EP02.mp4?rlkey=tuk9fmae61nvobmbmcuhl4rti&st=sks2tr5w&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          },
          {
            "id": 1759882108842,
            "title": "From EP03",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/k51b96ro597m7wizfdmx7/From_480P_S01_EP03.mp4?rlkey=dynizua6345wh7z43jw1f1m1s&st=hqoe92rw&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          },
          {
            "id": 1759882161644,
            "title": "From EP04",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/mnkollklzffsr4sa2dy1w/From_480P_S01_EP04.mp4?rlkey=2kldfynqofnc97x8fwoyc8gsq&st=56c1xoet&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          },
          {
            "id": 1759882197324,
            "title": "From EP05",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/3b18gdczv5gy89cnqn554/From_480P_S01_EP05.mp4?rlkey=zey6drpq9pb9en94sbjk59sns&st=k01exzti&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          },
          {
            "id": 1759882265469,
            "title": "From EP06",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/absdpzf6qnytum4dx0zs1/From_480P_S01_EP06.mp4?rlkey=db1tsolot4lupq54oplmh1nib&st=f49znje5&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          },
          {
            "id": 1759882296233,
            "title": "From EP07",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/gfen7jwn5ud3rd8z92pfr/From_480P_S01_EP07.mp4?rlkey=agzfyhxis0akyxn2mejwj1v6g&st=l6j2jyzn&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          },
          {
            "id": 1759882332304,
            "title": "From EP08",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/sagefhnx887e28om0g2pv/From_480P_S01_EP08.mp4?rlkey=yq24scr65r0a3zf3l691hp70f&st=mzh37wwm&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          },
          {
            "id": 1759882379396,
            "title": "From EP09",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/2t4jookduw6m0sn0kixzr/From_480P_S01_EP09.mp4?rlkey=c10xgari0t1pe81titay4jrcn&st=q7y511nf&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          },
          {
            "id": 1759882411873,
            "title": "From EP10",
            "description": "",
            "url": "https://www.dropbox.com/scl/fi/pnms1kjfl5phbbqc2fctn/From_480P_S01_EP10.mp4?rlkey=jvuiqi6boemmc3uuyz59phcwl&st=ejn0of8w&dl=1",
            "sources": {},
            "thumbnail": "https://www.dropbox.com/scl/fi/4a26b1uhyyetet0amcgks/MV5BYzM5ZWMxOGEtZjEyMC00YjQ0LThiYjEtZjVkZGEzN2NlOGEwXkEyXkFqcGc-._V1_.jpg?rlkey=z79522fazrfnsehtagl1dwma5&st=mqaidx3w&dl=1",
            "category": "episode"
          }
        ]
      }
    ],
    "episodes": []
  }
];
// ===== END OF MOVIES DATA =====

let currentVideo = null;

let currentPath = []; // stack of folder ids for nested navigation

// ===== SAVE PROJECT FUNCTIONALITY =====

async function saveProject() {

    if (!isAdmin) {

        alert('Only admin can save the project!');

        return;

    }

    try {

        const originalButtonText = document.getElementById('saveProjectBtn').textContent;

        document.getElementById('saveProjectBtn').textContent = '💾 Saving...';

        document.getElementById('saveProjectBtn').disabled = true;

        const response = await fetch('script.js?t=' + Date.now());

        const scriptContent = await response.text();

        const moviesJSON = JSON.stringify(movies, null, 2);

        let newScriptContent = scriptContent.replace(

            /\/\/ ===== MOVIES DATA[^]*?\/\/ ===== END OF MOVIES DATA =====/,

            `// ===== MOVIES DATA - This will be updated when you save the project =====\nlet movies = ${moviesJSON};\n// ===== END OF MOVIES DATA =====`

        );

        // Clean up excessive blank lines

        newScriptContent = newScriptContent.replace(/\n\n\n+/g, '\n\n');

        let savedToFile = false;

        try {

            const saveResponse = await fetch('/api/save-project', {

                method: 'POST',

                headers: { 'Content-Type': 'application/json' },

                body: JSON.stringify({ scriptContent: newScriptContent })

            });

            if (saveResponse.ok) {

                savedToFile = true;

                console.log('✅ Saved to project file');

            }

        } catch (serverError) {

            console.warn('Server save not available (using simple HTTP server?)');

        }

        const blob = new Blob([newScriptContent], { type: 'text/javascript' });

        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');

        a.href = url;

        a.download = 'script.js';

        document.body.appendChild(a);

        a.click();

        document.body.removeChild(a);

        URL.revokeObjectURL(url);

        document.getElementById('saveProjectBtn').textContent = originalButtonText;

        document.getElementById('saveProjectBtn').disabled = false;

        if (savedToFile) {

            alert('✅ Project saved successfully!\n\n✓ Updated your project\'s script.js file\n✓ Downloaded backup copy\n\nYour changes are now permanent!');

        } else {

            alert('✅ Project downloaded!\n\n⚠️ Auto-save to file not available (run admin-server.py for auto-save)\n\nPlease replace your script.js file with the downloaded one.');

        }

    } catch (err) {

        console.error('Error saving project:', err);

        document.getElementById('saveProjectBtn').textContent = '💾 Save Project';

        document.getElementById('saveProjectBtn').disabled = false;

        alert('❌ Error saving project. Please try again.');

    }

}

// ===== SEARCH FUNCTIONALITY =====

function initializeSearch() {

    const searchInput = document.getElementById('searchInput');

    const searchResults = document.getElementById('searchResults');

    if (!searchInput || !searchResults) return;

    // Debounce search to avoid too many updates

    let searchTimeout;

    searchInput.addEventListener('input', (e) => {

        clearTimeout(searchTimeout);

        const query = e.target.value.trim().toLowerCase();

        if (query.length === 0) {

            searchResults.classList.remove('active');

            searchResults.innerHTML = '';

            return;

        }

        searchTimeout = setTimeout(() => {

            performSearch(query);

        }, 200);

    });

    // Close search results when clicking outside

    document.addEventListener('click', (e) => {

        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {

            searchResults.classList.remove('active');

        }

    });

    // Show results when input is focused and has content

    searchInput.addEventListener('focus', () => {

        if (searchInput.value.trim().length > 0 && searchResults.innerHTML) {

            searchResults.classList.add('active');

        }

    });

}

function performSearch(query) {

    const searchResults = document.getElementById('searchResults');

    const allItems = getAllSearchableItems(movies);

    // Filter items that match the search query

    const matches = allItems.filter(item => {

        const titleMatch = item.title.toLowerCase().includes(query);

        const descMatch = (item.description || '').toLowerCase().includes(query);

        return titleMatch || descMatch;

    });

    if (matches.length === 0) {

        searchResults.innerHTML = '<div class="search-no-results">No results found for "' + escapeHtml(query) + '"</div>';

        searchResults.classList.add('active');

        return;

    }

    // Render search results (limit to 8 for performance)

    const html = matches.slice(0, 8).map(item => {

        const typeLabel = item.type === 'folder' ? 'Series' : (item.category === 'episode' ? 'Episode' : 'Movie');

        return `

            <div class="search-result-item" data-item-id="${item.id}" data-item-type="${item.type}">

                <img src="${item.thumbnail || 'https://via.placeholder.com/60x90?text=No+Image'}" 

                     alt="${escapeHtml(item.title)}" 

                     class="search-result-thumb"

                     onerror="this.src='https://via.placeholder.com/60x90?text=No+Image'">

                <div class="search-result-info">

                    <div class="search-result-title">${escapeHtml(item.title)}</div>

                    <div class="search-result-meta">

                        <span class="search-result-type">${typeLabel}</span>

                        ${item.description ? '<span>' + escapeHtml(item.description.substring(0, 40)) + (item.description.length > 40 ? '...' : '') + '</span>' : ''}

                    </div>

                </div>

            </div>

        `;

    }).join('');

    searchResults.innerHTML = html;

    searchResults.classList.add('active');

    // Add click handlers to search results

    searchResults.querySelectorAll('.search-result-item').forEach(el => {

        el.addEventListener('click', () => {

            const itemId = parseInt(el.dataset.itemId);

            const itemType = el.dataset.itemType;

            handleSearchResultClick(itemId, itemType);

            searchResults.classList.remove('active');

            document.getElementById('searchInput').value = '';

        });

    });

}

function getAllSearchableItems(items, path = []) {

    let result = [];

    // Only include root-level items (movies and series folders)

    // Do NOT include episodes or nested children

    items.forEach(item => {

        result.push({

            ...item,

            searchPath: [...path, item.id]

        });

    });

    return result;

}

function handleSearchResultClick(itemId, itemType) {

    const allItems = getAllSearchableItems(movies);

    const item = allItems.find(i => i.id === itemId);

    if (!item) return;

    // Navigate to the item's location

    if (item.searchPath && item.searchPath.length > 1) {

        // Build the path to this item

        currentPath = item.searchPath.slice(0, -1);

    } else {

        currentPath = [];

    }

    if (itemType === 'folder') {

        // Open the folder

        const folder = findItemById(movies, itemId);

        if (folder) {

            currentPath.push(itemId);

            renderMovies(folder.children || [], folder.episodes || []);

            updateAdminUI();

        }

    } else if (itemType === 'episode' || item.url) {

        // Play the video

        openVideoModal(item);

    }

}

function findItemById(items, id) {

    for (const item of items) {

        if (item.id === id) return item;

        if (item.children) {

            const found = findItemById(item.children, id);

            if (found) return found;

        }

    }

    return null;

}

function escapeHtml(text) {

    const div = document.createElement('div');

    div.textContent = text;

    return div.innerHTML;

}

// ===== END SEARCH FUNCTIONALITY =====

let isAdmin = false;

// Smart device detection and adaptive class application

function detectDeviceType(){

	try {

		const ua = navigator.userAgent.toLowerCase();

		const width = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);

		const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;

		const isPhoneUA = /mobile|iphone|ipod|android.+mobile|windows phone/.test(ua);

		const isTabletUA = /ipad|tablet|android(?!.*mobile)/.test(ua);

		if (width <= 640 || isPhoneUA) return 'device-phone';

		if (width <= 1024 || isTabletUA || (isTouch && width <= 1200)) return 'device-tablet';

		return 'device-desktop';

	} catch (_) { return 'device-desktop'; }

}

function applyDeviceClass(){

	const cls = detectDeviceType();

	const body = document.body || document.documentElement;

	body.classList.remove('device-phone','device-tablet','device-desktop');

	body.classList.add(cls);

}

// Initialize

document.addEventListener('DOMContentLoaded', async () => {

    // Determine admin strictly by localhost:9450

    try {

        const host = window.location.hostname;

        const port = String(window.location.port || '');

        isAdmin = (host === 'localhost' || host === '127.0.0.1') && (port === '9450');

    } catch (_) { isAdmin = false; }

    applyDeviceClass();

    window.addEventListener('resize', applyDeviceClass);

    window.addEventListener('orientationchange', applyDeviceClass);

    initializeSearch();

    loadMovies();

    initializeEventListeners();

    renderMovies();

    updateAdminUI();

});

// Load movies from localStorage (for temporary changes before saving)

function loadMovies() {

    try {

        const stored = localStorage.getItem('barni4movies');

        if (stored) {

            const parsed = JSON.parse(stored);

            if (Array.isArray(parsed)) {

                movies = parsed;

            }

        }

    } catch (_) {}

}

// Save movies to localStorage (temporary until project is saved)

function saveMovies() {

    try { 

        localStorage.setItem('barni4movies', JSON.stringify(movies)); 

    } catch (_) {}

}

function updateAdminUI() {

    const addBtn = document.getElementById('floatingAddBtn');

    if (addBtn) addBtn.style.display = isAdmin ? 'flex' : 'none';

    const saveProjectBtn = document.getElementById('saveProjectBtn');

    if (saveProjectBtn) saveProjectBtn.style.display = isAdmin ? 'block' : 'none';

    const mobileSave = document.getElementById('mobileSaveBtn');

    if (mobileSave) mobileSave.style.display = isAdmin ? 'block' : 'none';

    const addEpisodeBtn = document.getElementById('addEpisodeBtn');

    const addSubfolderBtn = document.getElementById('addSubfolderBtn');

    const inFolder = currentPath.length > 0;

    if (addEpisodeBtn) addEpisodeBtn.style.display = (isAdmin && inFolder) ? 'inline-block' : 'none';

    if (addSubfolderBtn) addSubfolderBtn.style.display = (isAdmin && inFolder) ? 'inline-block' : 'none';

}

// Save entire project - updates local file AND downloads backup

function getThumbnailUrl(url) {

    if (!url) return '';

    // Convert Dropbox preview links to direct image links

    if (url.includes('dropbox.com') && !url.includes('dl=1')) {

        url = url.replace('dl=0', 'dl=1');

        if (!url.includes('dl=1')) {

            url += (url.includes('?') ? '&' : '?') + 'dl=1';

        }

    }

    return url;

}

// Render movies grid

function renderMovies(filteredMovies = null) {

    const moviesGrid = document.getElementById('moviesGrid');

    const breadcrumbs = document.getElementById('breadcrumbs');

    const crumbTrail = document.getElementById('crumbTrail');

    const backBtn = document.getElementById('backToRoot');

    // Determine current container by path

    let container = { type: 'root', children: movies };

    for (const id of currentPath) {

        const next = (container.children || movies).find(x => x.id === id);

        if (!next) break;

        container = next;

    }

    let moviesToRender;

    if (container.type === 'folder') {

        const subfolders = container.children || [];

        const episodes = container.episodes || [];

        moviesToRender = [...subfolders, ...episodes];

        if (breadcrumbs) {

            breadcrumbs.style.display = 'flex';

            if (crumbTrail) {

                crumbTrail.innerHTML = '';

                const rootCrumb = document.createElement('span');

                rootCrumb.className = 'crumb';

                rootCrumb.textContent = 'Home';

                rootCrumb.onclick = () => { currentPath = []; renderMovies(); updateAdminUI(); };

                crumbTrail.appendChild(rootCrumb);

                let pathAccum = [];

                currentPath.forEach((id, idx) => {

                    const sep = document.createElement('span'); sep.className = 'sep'; sep.textContent = ' / ';

                    crumbTrail.appendChild(sep);

                    pathAccum.push(id);

                    const node = (movies.find(m => m.id === id)) || {};

                    const s = document.createElement('span'); s.className = 'crumb'; s.textContent = node.title || 'Folder';

                    s.onclick = () => { currentPath = pathAccum.slice(0, idx+1); renderMovies(); updateAdminUI(); };

                    crumbTrail.appendChild(s);

                });

            }

        }

        if (backBtn) backBtn.onclick = () => { currentPath.pop(); renderMovies(); updateAdminUI(); };

    } else {

        moviesToRender = filteredMovies || movies;

        if (breadcrumbs) breadcrumbs.style.display = 'none';

    }

    if (moviesToRender.length === 0) {

        moviesGrid.innerHTML = `

            <div style="grid-column: 1/-1; text-align: center; padding: 4rem;">

                <h3 style="color: var(--text-gray);">No movies found</h3>

                <p style="color: var(--text-gray); margin-top: 1rem;">Click the + button to add your first movie!</p>

            </div>

        `;

        return;

    }

    const myListIds = getMyList();

    const isRootLevel = currentPath.length === 0;

    moviesGrid.innerHTML = moviesToRender.map(item => {

        const isFolder = item.type === 'folder';

        const thumbnailUrl = getThumbnailUrl(item.thumbnail);

        const canDelete = isAdmin;

        const canEdit = isAdmin;

        const inMyList = myListIds.includes(item.id);

        const showMyListBtn = isRootLevel; // Show for both movies and series at root level

        return `

        <div class="movie-card ${isFolder ? 'folder-card' : ''}" data-id="${item.id}">

            ${canDelete ? `<button class="delete-btn" data-action="delete">×</button>` : ''}

            <div class="movie-thumbnail">

                ${isFolder ? `<div class="folder-badge">Folder</div>` : ''}

                ${thumbnailUrl ? 

                    `<img src="${thumbnailUrl}" alt="${item.title}" onerror="this.parentElement.innerHTML='<div style=\\'width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 4rem;\\'>🎬</div>'">` : 

                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 4rem;">🎬</div>`

                }

                <div class="play-overlay">

                    <span class="play-icon">${isFolder ? '📁' : '▶️'}</span>

                </div>

            </div>

            <div class="movie-info">

                <h3 class="movie-title">${item.title || 'Untitled'}</h3>

                <p class="movie-description">${item.description || 'No description available'}</p>

                <span class="movie-category">${isFolder ? 'Series' : (item.category || '')}</span>

                ${showMyListBtn ? `<button class=\"list-btn\" data-action=\"toggle-list\">${inMyList ? '✓ In My List' : '+ My List'}</button>` : ''}

                ${canEdit ? `<button class=\"edit-btn\" data-action=\"edit\">✏️ Edit</button>` : ''}

            </div>

        </div>`;

    }).join('');

    // Add click event to movie cards - optimized for performance

    const movieCards = document.querySelectorAll('.movie-card');

    movieCards.forEach(card => {

        card.addEventListener('click', handleCardClick, { passive: false });

    });

}

function handleCardClick(e) {

    const action = e.target.getAttribute('data-action');

    const idAttr = this.dataset.id;

    const itemId = idAttr ? parseInt(idAttr) : null;

    if (!itemId) return;

    if (action === 'delete') {

        e.stopPropagation();

        if (!isAdmin) return;

        deleteItem(itemId);

        return;

    }

    if (action === 'edit') {

        e.stopPropagation();

        if (!isAdmin) return;

        openEditModal(itemId);

        return;

    }

    if (action === 'toggle-list') {

        e.stopPropagation();

        toggleMyList(itemId);

        return;

    }

    // resolve current container

    let cont = { type: 'root', children: movies };

    for (const id of currentPath) {

        const next = (cont.children || movies).find(x => x.id === id);

        if (!next) break;

        cont = next;

    }

    if (cont.type === 'folder') {

        const sub = (cont.children || []).find(x => x.id === itemId);

        if (sub && sub.type === 'folder') {

            currentPath.push(itemId);

            renderMovies();

            updateAdminUI();

            return;

        }

        const ep = (cont.episodes || []).find(e => e.id === itemId);

        if (ep) {

            playEpisode(cont.id, itemId);

            return;

        }

    }

    const item = movies.find(m => m.id === itemId);

    if (item && item.type === 'folder') {

        currentPath.push(itemId);

        renderMovies();

        updateAdminUI();

        return;

    }

    playMovie(itemId);

}

// Play movie

function playMovie(movieId) {

    const movie = movies.find(m => m.id === movieId);

    if (!movie) return;

    currentVideo = movie;

    const modal = document.getElementById('videoModal');

    const video = document.getElementById('videoPlayer');

    const title = document.getElementById('videoTitle');

    const description = document.getElementById('videoDescription');

    const loadingSpinner = document.getElementById('loadingSpinner');

    // Pick initial source based on connection conditions

    const { src: chosenSrc, qualityKey } = chooseInitialSource(movie);

    video.src = chosenSrc;

    if (qualityKey) video.dataset.currentQuality = qualityKey;

    title.textContent = movie.title;

    description.textContent = movie.description || 'No description available';

    // Show modal

    modal.classList.add('active');

    loadingSpinner.classList.add('show');

    // Auto play

    video.play().catch(err => {

        console.log('Autoplay prevented:', err);

        loadingSpinner.classList.remove('show');

    });

    // Hide loading spinner when video starts playing

    video.addEventListener('playing', () => {

        loadingSpinner.classList.remove('show');

    });

    video.addEventListener('waiting', () => {

        loadingSpinner.classList.add('show');

    });

    // Prevent right-click and download

    video.oncontextmenu = (e) => {

        e.preventDefault();

        return false;

    };

    // Initialize video controls

    initializeVideoControls();

    // Start adaptive switching based on buffering

    startAdaptiveStreaming(movie);

}

// Find item recursively in nested structure

function findItemById(list, id) {

    for (const item of list) {

        if (item.id === id) return item;

        if (item.children) {

            const found = findItemById(item.children, id);

            if (found) return found;

        }

        if (item.episodes) {

            const found = findItemById(item.episodes, id);

            if (found) return found;

        }

    }

    return null;

}

function playEpisode(folderId, episodeId) {

    // Find episode by ID recursively

    const ep = findItemById(movies, episodeId);

    if (!ep) return;

    // Temporarily use movie play with episode object

    const tempMovie = {

        id: ep.id,

        title: ep.title,

        description: ep.description,

        url: ep.url,

        sources: ep.sources,

        thumbnail: ep.thumbnail,

        category: 'episode'

    };

    currentVideo = tempMovie;

    const modal = document.getElementById('videoModal');

    const video = document.getElementById('videoPlayer');

    const title = document.getElementById('videoTitle');

    const description = document.getElementById('videoDescription');

    const loadingSpinner = document.getElementById('loadingSpinner');

    const { src: chosenSrc, qualityKey } = chooseInitialSource(tempMovie);

    video.src = chosenSrc;

    if (qualityKey) video.dataset.currentQuality = qualityKey;

    title.textContent = tempMovie.title;

    description.textContent = tempMovie.description || 'No description available';

    modal.classList.add('active');

    loadingSpinner.classList.add('show');

    video.play().catch(() => { loadingSpinner.classList.remove('show'); });

    video.addEventListener('playing', () => loadingSpinner.classList.remove('show'));

    video.addEventListener('waiting', () => loadingSpinner.classList.add('show'));

    video.oncontextmenu = (e) => { e.preventDefault(); return false; };

    initializeVideoControls();

    startAdaptiveStreaming(tempMovie);

}

// Choose best available source

function getBestSource(movie) {

    if (movie.sources) {

        return movie.sources['1080p'] || movie.sources['720p'] || movie.sources['480p'] || movie.url;

    }

    return movie.url;

}

function chooseInitialSource(movie) {

    const qualityOrder = ['1080p', '720p', '480p'];

    const available = (movie.sources ? qualityOrder.filter(q => !!movie.sources[q]) : []);

    let preferred = '1080p';

    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;

    if (conn && conn.effectiveType) {

        const et = conn.effectiveType.toLowerCase();

        if (et.includes('2g')) preferred = '480p';

        else if (et.includes('3g')) preferred = '720p';

        else preferred = '1080p';

    }

    const qualityKey = available.includes(preferred)

        ? preferred

        : (available[0] || null);

    if (qualityKey && movie.sources) {

        return { src: movie.sources[qualityKey], qualityKey };

    }

    return { src: movie.url, qualityKey: null };

}

// Switch quality preserving time and state (internal use if we later need)

function switchQuality(movie, quality) {

    const video = document.getElementById('videoPlayer');

    const currentTime = video.currentTime || 0;

    const wasPaused = video.paused;

    const playbackRate = video.playbackRate;

    const volume = video.volume;

    let newSrc = getBestSource(movie);

    if (quality && quality !== 'auto' && movie.sources && movie.sources[quality]) {

        newSrc = movie.sources[quality];

    }

    // Hint start-time via media fragments for faster server range (if supported)

    video.src = withTimeFragment(newSrc, currentTime);

    if (quality && quality !== 'auto') video.dataset.currentQuality = quality;

    video.playbackRate = playbackRate;

    video.volume = volume;

    const playPromise = video.play();

    if (playPromise) {

        playPromise.catch(() => {});

    }

    // Seek once metadata is loaded

    video.addEventListener('loadedmetadata', function handle() {

        video.currentTime = Math.min(currentTime, video.duration || currentTime);

        if (wasPaused) video.pause();

        video.removeEventListener('loadedmetadata', handle);

    });

}

function withTimeFragment(src, seconds) {

    try {

        const base = src.split('#')[0];

        const t = Math.max(0, Math.floor(seconds));

        return `${base}#t=${t}`;

    } catch (_) {

        return src;

    }

}

// Adaptive switching controller

function startAdaptiveStreaming(movie) {

    const video = document.getElementById('videoPlayer');

    const hasMulti = !!(movie.sources && (movie.sources['1080p'] || movie.sources['720p'] || movie.sources['480p']));

    if (!hasMulti) return;

    const qualityOrder = ['1080p', '720p', '480p'];

    const available = qualityOrder.filter(q => !!movie.sources[q]);

    if (available.length === 0) return;

    let waitingStartMs = null;

    let recentRebufferMs = 0;

    let lastCheckTs = performance.now();

    let stablePlaybackMs = 0;

    let downgradeCooldownMs = 5000;

    let lastSwitchTs = 0;

    function currentQualityKey() {

        return video.dataset.currentQuality || available[0];

    }

    function lowerQuality(q) {

        const idx = available.indexOf(q);

        return idx >= 0 && idx < available.length - 1 ? available[idx + 1] : null;

    }

    function higherQuality(q) {

        const idx = available.indexOf(q);

        return idx > 0 ? available[idx - 1] : null;

    }

    function tryDowngrade(reason) {

        const now = performance.now();

        if (now - lastSwitchTs < downgradeCooldownMs) return;

        const cur = currentQualityKey();

        const down = lowerQuality(cur);

        if (!down) return;

        lastSwitchTs = now;

        switchQuality(movie, down);

    }

    function tryUpgrade() {

        const now = performance.now();

        if (now - lastSwitchTs < 8000) return;

        const cur = currentQualityKey();

        const up = higherQuality(cur);

        if (!up) return;

        lastSwitchTs = now;

        switchQuality(movie, up);

    }

    function bufferAhead() {

        try {

            const b = video.buffered;

            if (!b || b.length === 0) return 0;

            const end = b.end(b.length - 1);

            return Math.max(0, end - video.currentTime);

        } catch (_) { return 0; }

    }

    function onWaiting() {

        if (waitingStartMs == null) waitingStartMs = performance.now();

    }

    function onPlaying() {

        const now = performance.now();

        if (waitingStartMs != null) {

            recentRebufferMs += now - waitingStartMs;

            waitingStartMs = null;

        }

        if (bufferAhead() < 3) {

            tryDowngrade('low-buffer');

        }

    }

    function onTimeUpdate() {

        const now = performance.now();

        const dt = now - lastCheckTs;

        lastCheckTs = now;

        if (!video.paused && !video.seeking) {

            if (waitingStartMs == null) {

                stablePlaybackMs += dt;

            }

        }

        // If rebuffering exceeded 1500ms within recent window, downgrade

        if (recentRebufferMs > 1500 || bufferAhead() < 2) {

            tryDowngrade('rebuffer');

            recentRebufferMs = 0;

            stablePlaybackMs = 0;

        }

        // Upgrade after 20s stable playback and comfortable buffer

        if (stablePlaybackMs > 20000 && bufferAhead() > 8) {

            tryUpgrade();

            stablePlaybackMs = 0;

        }

    }

    video.addEventListener('waiting', onWaiting);

    video.addEventListener('playing', onPlaying);

    video.addEventListener('timeupdate', onTimeUpdate);

    video.addEventListener('seeking', () => { recentRebufferMs = 0; stablePlaybackMs = 0; });

    // Cleanup when modal closes

    const cleanup = () => {

        video.removeEventListener('waiting', onWaiting);

        video.removeEventListener('playing', onPlaying);

        video.removeEventListener('timeupdate', onTimeUpdate);

    };

    video._adaptiveCleanup = cleanup;

}

// Initialize custom video controls

function initializeVideoControls() {

    const video = document.getElementById('videoPlayer');

    if (video._controlsInit) return; // prevent duplicate listeners across opens

    video._controlsInit = true;

    const playPauseBtn = document.getElementById('playPauseBtn');

    const progressBar = document.getElementById('progressBar');

    const currentTimeEl = document.getElementById('currentTime');

    const durationEl = document.getElementById('duration');

    const volumeBtn = document.getElementById('volumeBtn');

    const volumeSlider = document.getElementById('volumeSlider');

    const speedBtn = document.getElementById('speedBtn');

    const speedMenu = document.getElementById('speedMenu');

    const fullscreenBtn = document.getElementById('fullscreenBtn');

    const centerPlay = document.getElementById('centerPlay');

    const customControls = document.getElementById('customControls');

    const videoWrapper = document.querySelector('.video-wrapper');

    const loadingSpinner = document.getElementById('loadingSpinner');

    // Play/Pause

    playPauseBtn.addEventListener('click', togglePlayPause);

    video.addEventListener('click', togglePlayPause);

    function togglePlayPause() {

        if (video.paused) {

            video.play();

            playPauseBtn.textContent = '⏸️';

            centerPlay.classList.add('show');

            setTimeout(() => centerPlay.classList.remove('show'), 600);

        } else {

            video.pause();

            playPauseBtn.textContent = '▶️';

            centerPlay.classList.add('show');

            setTimeout(() => centerPlay.classList.remove('show'), 600);

        }

    }

    // Update play button when video state changes

    video.addEventListener('play', () => {

        playPauseBtn.textContent = '⏸️';

    });

    video.addEventListener('pause', () => {

        playPauseBtn.textContent = '▶️';

    });

    // Progress bar

    let isDraggingProgress = false;

    video.addEventListener('timeupdate', () => {

        const progress = (video.currentTime / video.duration) * 100;

        progressBar.value = progress || 0;

        if (!isDraggingProgress) {

            currentTimeEl.textContent = formatTime(video.currentTime);

        }

    });

    video.addEventListener('loadedmetadata', () => {

        durationEl.textContent = formatTime(video.duration);

    });

    // Scrub behavior: smooth, accurate seeking with no sync issues

    let seekTimeout;

    let lastSeekTime = 0;

    function applySeek(targetTime) {

        // Cancel any pending seeks to prevent conflicts

        if (seekTimeout) {

            clearTimeout(seekTimeout);

        }

        // Prevent too-frequent seeks (debounce)

        const now = Date.now();

        if (now - lastSeekTime < 50) {

            seekTimeout = setTimeout(() => applySeek(targetTime), 50);

            return;

        }

        lastSeekTime = now;

        // Show loading indicator

        try { loadingSpinner.classList.add('show'); } catch (_) {}

        // Clamp target time to valid range

        const clampedTime = Math.max(0, Math.min(targetTime, video.duration || targetTime));

        // Use fastSeek for optimal performance if available (Chrome/Edge)

        // Otherwise use standard seeking - both maintain perfect sync

        if (typeof video.fastSeek === 'function') {

            try {

                video.fastSeek(clampedTime);

            } catch (e) {

                video.currentTime = clampedTime;

            }

        } else {

            video.currentTime = clampedTime;

        }

        // Hide loading spinner once seeking completes

        video.addEventListener('seeked', function hideSpinnerOnSeek() {

            try { loadingSpinner.classList.remove('show'); } catch (_) {}

            video.removeEventListener('seeked', hideSpinnerOnSeek);

        }, { once: true });

    }

    // Seek helper that guarantees A/V sync:

    // 1) pause and mute

    // 2) seek to target

    // 3) wait until ready (no longer seeking and readyState >= 3)

    // 4) resume if it was playing before; unmute when actually playing

    function seekAndSync(targetTime){

        const wasPlaying = !video.paused;

        const prevMuted = video.muted;

        // Pause and mute during seek to avoid audible desync

        try { video.pause(); } catch(_) {}

        video.muted = true;

        // Perform the seek

        applySeek(targetTime);

        let resumed = false;

        const tryResume = () => {

            if (resumed) return;

            if (video.seeking) return;

            // HAVE_FUTURE_DATA (3) is sufficient for smooth resume

            if (typeof video.readyState === 'number' && video.readyState < 3) return;

            resumed = true;

            video.removeEventListener('canplay', tryResume);

            video.removeEventListener('timeupdate', tryResume);

            video.removeEventListener('seeked', tryResume);

            // If it was playing before, resume; otherwise just finalize UI

            if (wasPlaying) {

                const p = video.play();

                if (p && typeof p.then === 'function') { p.catch(()=>{}); }

            } else {

                try { loadingSpinner.classList.remove('show'); } catch (_) {}

                video.muted = prevMuted;

            }

        };

        video.addEventListener('canplay', tryResume);

        video.addEventListener('timeupdate', tryResume);

        video.addEventListener('seeked', tryResume);

        // Unmute exactly when playback actually resumes

        const onPlaying = () => {

            try { loadingSpinner.classList.remove('show'); } catch (_) {}

            video.muted = prevMuted;

            video.removeEventListener('playing', onPlaying);

        };

        video.addEventListener('playing', onPlaying);

    }

    progressBar.addEventListener('input', () => {

        isDraggingProgress = true;

        const time = (progressBar.value / 100) * (video.duration || 0);

        currentTimeEl.textContent = formatTime(time);

    });

    const commitSeek = () => {

        if (!isDraggingProgress) return;

        const time = (progressBar.value / 100) * (video.duration || 0);

        seekAndSync(time);

        isDraggingProgress = false;

    };

    progressBar.addEventListener('change', commitSeek);

    progressBar.addEventListener('mouseup', commitSeek);

    progressBar.addEventListener('touchend', commitSeek, { passive: true });

    // Volume control

    volumeSlider.addEventListener('input', () => {

        video.volume = volumeSlider.value / 100;

        updateVolumeIcon();

    });

    volumeBtn.addEventListener('click', () => {

        if (video.volume > 0) {

            video.volume = 0;

            volumeSlider.value = 0;

        } else {

            video.volume = 1;

            volumeSlider.value = 100;

        }

        updateVolumeIcon();

    });

    function updateVolumeIcon() {

        if (video.volume === 0) {

            volumeBtn.textContent = '🔇';

        } else if (video.volume < 0.5) {

            volumeBtn.textContent = '🔉';

        } else {

            volumeBtn.textContent = '🔊';

        }

    }

    // Playback speed

    speedBtn.onclick = (e) => {

        e.stopPropagation();

        speedMenu.classList.toggle('show');

    };

    document.querySelectorAll('.speed-option').forEach(option => {

        option.onclick = (e) => {

            e.stopPropagation();

            const speed = parseFloat(option.dataset.speed);

            video.playbackRate = speed;

            speedBtn.textContent = speed + 'x';

            document.querySelectorAll('.speed-option').forEach(opt => opt.classList.remove('active'));

            option.classList.add('active');

            speedMenu.classList.remove('show');

        };

    });

    // Close menus when clicking elsewhere

    const closeMenusHandler = () => {

        speedMenu.classList.remove('show');

    };

    document.addEventListener('click', closeMenusHandler);

    // Fullscreen

    fullscreenBtn.addEventListener('click', toggleFullscreen);

    function toggleFullscreen() {

        // Prefer true container fullscreen for controls overlay

        if (!document.fullscreenElement && !document.webkitFullscreenElement) {

            if (videoWrapper.requestFullscreen) {

                videoWrapper.requestFullscreen();

            } else if (videoWrapper.webkitRequestFullscreen) {

                videoWrapper.webkitRequestFullscreen();

            } else if (videoWrapper.mozRequestFullScreen) {

                videoWrapper.mozRequestFullScreen();

            } else if (videoWrapper.msRequestFullscreen) {

                videoWrapper.msRequestFullscreen();

            } else if (video.webkitEnterFullscreen) {

                // iOS Safari fallback: enter native video fullscreen

                video.webkitEnterFullscreen();

            }

        } else {

            if (document.exitFullscreen) {

                document.exitFullscreen();

            } else if (document.webkitExitFullscreen) {

                document.webkitExitFullscreen();

            } else if (document.mozCancelFullScreen) {

                document.mozCancelFullScreen();

            } else if (document.msExitFullscreen) {

                document.msExitFullscreen();

            }

        }

    }

    // Dynamically choose best object-fit in fullscreen to avoid black borders

    function adjustFullscreenFit() {

        const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);

        // Reset when leaving fullscreen

        if (!isFs) {

            try {

                video.style.objectFit = '';

                video.style.objectPosition = '';

                video.style.width = '';

                video.style.height = '';

            } catch(_) {}

            return;

        }

        // Detect if this is a mobile device (phone or tablet)

        const body = document.body || document.documentElement;

        const isPhone = body.classList.contains('device-phone');

        const isTablet = body.classList.contains('device-tablet');

        const isMobile = isPhone || isTablet;

        // Also check user agent as fallback

        const ua = navigator.userAgent.toLowerCase();

        const isMobileUA = /mobile|iphone|ipod|android|tablet|ipad/.test(ua);

        let fit = 'contain';

        // For mobile devices, ALWAYS use cover to eliminate black borders

        if (isMobile || isMobileUA) {

            fit = 'cover';

        } else {

            // Desktop: check aspect ratio to decide

            const vw = Math.max(window.innerWidth || 0, screen.width || 0);

            const vh = Math.max(window.innerHeight || 0, screen.height || 0);

            const vW = video.videoWidth || 16;

            const vH = video.videoHeight || 9;

            const viewportAR = vw / Math.max(1, vh);

            const videoAR = vW / Math.max(1, vH);

            const diff = Math.abs(viewportAR - videoAR);

            // If aspect ratios are close, use contain; otherwise use cover

            fit = diff > 0.15 ? 'cover' : 'contain';

        }

        try {

            video.style.objectFit = fit;

            video.style.objectPosition = 'center center';

            video.style.width = '100%';

            video.style.height = '100%';

        } catch(_) {}

    }

    // Update icon based on fullscreenchange

    function syncFullscreenIcon() {

        const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement);

        fullscreenBtn.textContent = isFs ? '🗗' : '⛶';

    }

    document.addEventListener('fullscreenchange', () => { syncFullscreenIcon(); adjustFullscreenFit(); });

    document.addEventListener('webkitfullscreenchange', () => { syncFullscreenIcon(); adjustFullscreenFit(); });

    video.addEventListener('loadedmetadata', adjustFullscreenFit);

    window.addEventListener('resize', adjustFullscreenFit);

    window.addEventListener('orientationchange', adjustFullscreenFit);

    screen.orientation?.addEventListener('change', adjustFullscreenFit);

    // Keyboard shortcuts

    document.addEventListener('keydown', handleKeyPress);

    function handleKeyPress(e) {

        const modal = document.getElementById('videoModal');

        if (!modal.classList.contains('active')) return;

        switch(e.key.toLowerCase()) {

            case ' ':

            case 'k':

                e.preventDefault();

                togglePlayPause();

                break;

            case 'f':

                e.preventDefault();

                toggleFullscreen();

                break;

            case 'm':

                e.preventDefault();

                volumeBtn.click();

                break;

            case 'arrowleft':

                e.preventDefault();

                seekAndSync(video.currentTime - 5);

                break;

            case 'arrowright':

                e.preventDefault();

                seekAndSync(video.currentTime + 5);

                break;

            case 'arrowup':

                e.preventDefault();

                video.volume = Math.min(video.volume + 0.1, 1);

                volumeSlider.value = video.volume * 100;

                updateVolumeIcon();

                break;

            case 'arrowdown':

                e.preventDefault();

                video.volume = Math.max(video.volume - 0.1, 0);

                volumeSlider.value = video.volume * 100;

                updateVolumeIcon();

                break;

        }

    }

    // Auto-hide controls on idle (3s)

    let controlsTimeout;

    function armAutoHide() {

        clearTimeout(controlsTimeout);

        videoWrapper.classList.remove('hide-controls');

        customControls.classList.add('show');

        if (!video.paused) {

            controlsTimeout = setTimeout(() => {

                videoWrapper.classList.add('hide-controls');

                customControls.classList.remove('show');

            }, 3000);

        }

    }

    // Show on mouse move/enter

    ['mousemove', 'mouseenter'].forEach(evt => {

        videoWrapper.addEventListener(evt, armAutoHide);

    });

    // Also on key interactions

    ['play', 'pause', 'seeking', 'volumechange', 'ratechange'].forEach(evt => {

        video.addEventListener(evt, armAutoHide);

    });

    // Initial arm

    armAutoHide();

}

// Format time helper

function formatTime(seconds) {

    if (isNaN(seconds)) return '0:00';

    const hours = Math.floor(seconds / 3600);

    const minutes = Math.floor((seconds % 3600) / 60);

    const secs = Math.floor(seconds % 60);

    if (hours > 0) {

        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

    }

    return `${minutes}:${secs.toString().padStart(2, '0')}`;

}

// Delete movie

function deleteMovie(movieId) {

    if (confirm('Are you sure you want to delete this movie?')) {

        movies = movies.filter(m => m.id !== movieId);

        saveMovies();

        renderMovies();

    }

}

// Recursive delete for nested structure

function deleteItemRecursive(list, itemId) {

    for (let i = 0; i < list.length; i++) {

        if (list[i].id === itemId) {

            list.splice(i, 1);

            return true;

        }

        if (list[i].children && deleteItemRecursive(list[i].children, itemId)) return true;

        if (list[i].episodes && deleteItemRecursive(list[i].episodes, itemId)) return true;

    }

    return false;

}

function deleteItem(itemId) {

    if (!isAdmin) return;

    if (confirm('Delete this item?')) {

        deleteItemRecursive(movies, itemId);

        saveMovies();

        renderMovies();

    }

}

function deleteEpisode(folderId, episodeId) {

    if (!isAdmin) return;

    if (confirm('Delete this episode?')) {

        deleteItemRecursive(movies, episodeId);

        saveMovies();

        renderMovies();

    }

}

// Initialize event listeners

function initializeEventListeners() {

    // Save Project button

    const saveProjectBtn = document.getElementById('saveProjectBtn');

    if (saveProjectBtn) {

        saveProjectBtn.addEventListener('click', saveProject);

    }

    // Mobile menu wiring

    const mobileMenuBtn = document.getElementById('mobileMenuBtn');

    const mobileMenu = document.getElementById('mobileMenu');

    const closeMobileMenuBtn = document.getElementById('closeMobileMenuBtn');

    const mNavHome = document.getElementById('mNavHome');

    const mNavMovies = document.getElementById('mNavMovies');

    const mNavSeries = document.getElementById('mNavSeries');

    const mNavMyList = document.getElementById('mNavMyList');

    const mobileSaveBtn = document.getElementById('mobileSaveBtn');

    if (mobileMenuBtn && mobileMenu) {

        mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.add('active'));

    }

    if (closeMobileMenuBtn && mobileMenu) {

        closeMobileMenuBtn.addEventListener('click', () => mobileMenu.classList.remove('active'));

        mobileMenu.addEventListener('click', (e)=>{ if (e.target === mobileMenu) mobileMenu.classList.remove('active'); });

    }

    const closeMenuAnd = (fn)=> (e)=>{ e.preventDefault(); try{ mobileMenu.classList.remove('active'); }catch(_){}; fn(); };

    if (mNavHome) mNavHome.addEventListener('click', closeMenuAnd(()=>{ const navHome=document.getElementById('navHome'); if (navHome) navHome.click(); }));

    if (mNavMovies) mNavMovies.addEventListener('click', closeMenuAnd(()=>{ const navMovies=document.getElementById('navMovies'); if (navMovies) navMovies.click(); }));

    if (mNavSeries) mNavSeries.addEventListener('click', closeMenuAnd(()=>{ const navSeries=document.getElementById('navSeries'); if (navSeries) navSeries.click(); }));

    if (mNavMyList) mNavMyList.addEventListener('click', closeMenuAnd(()=>{ const navMyList=document.getElementById('navMyList'); if (navMyList) navMyList.click(); }));

    if (mobileSaveBtn) mobileSaveBtn.addEventListener('click', closeMenuAnd(()=> saveProject()));

    // Close video modal

    const closeBtn = document.getElementById('closeBtn');

    const videoModal = document.getElementById('videoModal');

    const video = document.getElementById('videoPlayer');

    closeBtn.addEventListener('click', () => {

        closeVideoModal();

    });

    // Close modal when clicking outside

    videoModal.addEventListener('click', (e) => {

        if (e.target === videoModal) {

            closeVideoModal();

        }

    });

    function closeVideoModal() {

        videoModal.classList.remove('active');

        video.pause();

        video.src = '';

        if (video._adaptiveCleanup) { try { video._adaptiveCleanup(); } catch (_) {} }

        // If in fullscreen, exit

        if (document.fullscreenElement || document.webkitFullscreenElement) {

            if (document.exitFullscreen) document.exitFullscreen();

            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();

        }

        // Reset video fit

        try { video.style.objectFit=''; video.style.objectPosition=''; } catch(_) {}

        // Remove keyboard event listener

        document.removeEventListener('keydown', handleKeyPress);

    }

    // Floating add button

    const floatingAddBtn = document.getElementById('floatingAddBtn');

    const addMovieModal = document.getElementById('addMovieModal');

    const closeAddBtn = document.getElementById('closeAddBtn');

    floatingAddBtn.addEventListener('click', () => {

        if (!isAdmin) return;

        // Reset form first

        addMovieForm.reset();

        // Set defaults based on current view

        document.querySelector('input[name="contentType"][value="movie"]').checked = true;

        document.querySelector('input[name="contentType"][value="series"]').checked = false;

        document.getElementById('movieUrlFields').style.display = 'block';

        addMovieModal.classList.add('active');

    });

    closeAddBtn.addEventListener('click', () => {

        addMovieModal.classList.remove('active');

    });

    // Close add modal when clicking outside

    addMovieModal.addEventListener('click', (e) => {

        if (e.target === addMovieModal) {

            addMovieModal.classList.remove('active');

        }

    });

    // Add movie form

    const addMovieForm = document.getElementById('addMovieForm');

    addMovieForm.addEventListener('submit', (e) => {

        e.preventDefault();

        if (!isAdmin) { alert('Only admin on localhost can add.'); return; }

        const title = document.getElementById('movieTitle').value.trim();

        const description = document.getElementById('movieDescription').value.trim();

        const contentType = document.querySelector('input[name="contentType"]:checked').value;

        let url = document.getElementById('movieUrl').value.trim();

        let url1080 = document.getElementById('movieUrl1080').value.trim();

        let url720 = document.getElementById('movieUrl720').value.trim();

        let url480 = document.getElementById('movieUrl480').value.trim();

        const thumbnail = document.getElementById('movieThumbnail').value.trim();

        const category = document.getElementById('movieCategory').value;

        // Validate required fields

        if (!title) {

            alert('Title is required');

            return;

        }

        // For series folders, URL is not needed

        if (contentType === 'series') {

            // Series folder doesn't need URL

            url = '';

            url1080 = '';

            url720 = '';

            url480 = '';

        } else {

            // For movies, URL is required

            if (!url) {

                alert('Video URL is required for movies');

                return;

            }

            // Ensure the URL ends with dl=1

            if (!url.includes('dl=1')) {

                if (url.includes('dl=0')) {

                    url = url.replace('dl=0', 'dl=1');

                } else {

                    url += (url.includes('?') ? '&' : '?') + 'dl=1';

                }

            }

            // Normalize optional quality URLs

            function normalize(u) {

                if (!u) return '';

                if (!u.includes('dl=1')) {

                    if (u.includes('dl=0')) u = u.replace('dl=0', 'dl=1');

                    else u += (u.includes('?') ? '&' : '?') + 'dl=1';

                }

                return u;

            }

            url1080 = normalize(url1080);

            url720 = normalize(url720);

            url480 = normalize(url480);

        }

        if (contentType === 'series' && currentPath.length === 0) {

            const newFolder = {

                id: Date.now(),

                type: 'folder',

                title,

                description,

                thumbnail,

                category,

                children: [],

                episodes: []

            };

            movies.push(newFolder);

        } else if (currentPath.length > 0) {

            // Adding to current folder (nested path)

            let cont = { type: 'root', children: movies };

            for (const id of currentPath) {

                const next = (cont.children || []).find(i => i.id === id);

                if (!next) return;

                cont = next;

            }

            if (contentType === 'series') {

                // Create subfolder inside current folder

                const subfolder = {

                    id: Date.now(),

                    type: 'folder',

                    title,

                    description,

                    thumbnail,

                    category,

                    children: [],

                    episodes: []

                };

                cont.children = cont.children || [];

                cont.children.push(subfolder);

            } else {

                // Create episode inside current folder

                const episode = {

                    id: Date.now(),

                    title,

                    description,

                    url,

                    sources: {

                        ...(url1080 ? { '1080p': url1080 } : {}),

                        ...(url720 ? { '720p': url720 } : {}),

                        ...(url480 ? { '480p': url480 } : {})

                    },

                    thumbnail,

                    category: 'episode'

                };

                cont.episodes = cont.episodes || [];

                cont.episodes.push(episode);

            }

        } else {

            const newMovie = {

                id: Date.now(),

                title,

                description,

                url,

                sources: {

                    ...(url1080 ? { '1080p': url1080 } : {}),

                    ...(url720 ? { '720p': url720 } : {}),

                    ...(url480 ? { '480p': url480 } : {})

                },

                thumbnail,

                category

            };

            movies.push(newMovie);

        }

        saveMovies();

        renderMovies();

        updateAdminUI();

        // Reset form and close modal

        addMovieForm.reset();

        addMovieModal.classList.remove('active');

        // Show success message

        if (contentType === 'series') {

            alert('Series folder created successfully! Click to open and add episodes. 📁');

        } else {

            alert('Movie added successfully! 🎬');

        }

    });

    // Toggle URL fields if Series Folder is selected

    document.querySelectorAll('input[name="contentType"]').forEach(r => {

        r.addEventListener('change', () => {

            const isSeries = document.querySelector('input[name="contentType"]:checked').value === 'series';

            const urlFields = document.getElementById('movieUrlFields');

            if (urlFields) {

                urlFields.style.display = isSeries ? 'none' : 'block';

            }

        });

    });

    // Add Subfolder / Episode Modal handlers

    const addEpisodeModal = document.getElementById('addEpisodeModal');

    const closeAddEpisodeBtn = document.getElementById('closeAddEpisodeBtn');

    const addEpisodeForm = document.getElementById('addEpisodeForm');

    const addEpisodeBtn = document.getElementById('addEpisodeBtn');

    const addSubfolderBtn = document.getElementById('addSubfolderBtn');

    if (addEpisodeBtn) addEpisodeBtn.addEventListener('click', () => {

        if (!isAdmin || currentPath.length===0) return;

        addEpisodeModal.classList.add('active');

    });

    if (addSubfolderBtn) addSubfolderBtn.addEventListener('click', () => {

        if (!isAdmin || currentPath.length===0) return;

        const title = prompt('New subfolder title');

        if (!title) return;

        // Find current container

        let cont = { type:'root', children: movies };

        for (const id of currentPath) {

            const next = (cont.children || movies).find(x => x.id === id);

            if (!next) break;

            cont = next;

        }

        if (cont.type !== 'folder') return;

        cont.children = cont.children || [];

        cont.children.push({ id: Date.now(), type:'folder', title, description:'', thumbnail:'', category:'series', children:[], episodes:[] });

        saveMovies(); renderMovies(); updateAdminUI();

    });

    if (closeAddEpisodeBtn) closeAddEpisodeBtn.addEventListener('click', () => addEpisodeModal.classList.remove('active'));

    if (addEpisodeModal) addEpisodeModal.addEventListener('click', (e) => { if (e.target === addEpisodeModal) addEpisodeModal.classList.remove('active'); });

    if (addEpisodeForm) addEpisodeForm.addEventListener('submit', (e) => {

        e.preventDefault();

        if (!isAdmin || currentPath.length===0) return;

        const title = document.getElementById('episodeTitle').value;

        const description = document.getElementById('episodeDescription').value;

        let url = document.getElementById('episodeUrl').value;

        let url1080 = document.getElementById('episodeUrl1080').value;

        let url720 = document.getElementById('episodeUrl720').value;

        let url480 = document.getElementById('episodeUrl480').value;

        const thumbnail = document.getElementById('episodeThumbnail').value;

        function normalize(u) {

            if (!u) return '';

            if (!u.includes('dl=1')) {

                if (u.includes('dl=0')) u = u.replace('dl=0', 'dl=1');

                else u += (u.includes('?') ? '&' : '?') + 'dl=1';

            }

            return u;

        }

        url = normalize(url);

        url1080 = normalize(url1080);

        url720 = normalize(url720);

        url480 = normalize(url480);

        // Resolve folder by path

        let folder;

        let cont = { type:'root', children: movies };

        for (const id of currentPath) {

            const next = (cont.children || movies).find(x => x.id === id);

            if (!next) break;

            cont = next;

        }

        folder = cont.type === 'folder' ? cont : null;

        if (folder) {

            folder.episodes = folder.episodes || [];

            folder.episodes.push({

                id: Date.now(),

                title,

                description,

                url,

                sources: {

                    ...(url1080 ? { '1080p': url1080 } : {}),

                    ...(url720 ? { '720p': url720 } : {}),

                    ...(url480 ? { '480p': url480 } : {})

                },

                thumbnail,

                category: 'episode'

            });

            saveMovies();

            renderMovies();

            updateAdminUI();

            addEpisodeForm.reset();

            addEpisodeModal.classList.remove('active');

        }

    });

    // Edit item modal

    const editItemModal = document.getElementById('editItemModal');

    const closeEditItemBtn = document.getElementById('closeEditItemBtn');

    const editItemForm = document.getElementById('editItemForm');

    if (closeEditItemBtn) closeEditItemBtn.addEventListener('click', () => editItemModal.classList.remove('active'));

    if (editItemModal) editItemModal.addEventListener('click', (e) => { if (e.target === editItemModal) editItemModal.classList.remove('active'); });

    window.openEditModal = function(itemId){

        const item = findItemById(movies, itemId);

        if (!item) return;

        document.getElementById('editTitle').value = item.title || '';

        document.getElementById('editDescription').value = item.description || '';

        document.getElementById('editThumbnail').value = item.thumbnail || '';

        editItemForm.dataset.itemId = String(itemId);

        editItemModal.classList.add('active');

    }

    if (editItemForm) editItemForm.addEventListener('submit', (e) => {

        e.preventDefault();

        if (!isAdmin) return;

        const itemId = parseInt(editItemForm.dataset.itemId);

        const title = document.getElementById('editTitle').value;

        const description = document.getElementById('editDescription').value;

        const thumbnail = document.getElementById('editThumbnail').value;

        const item = findItemById(movies, itemId);

        if (!item) return;

        item.title = title;

        item.description = description;

        item.thumbnail = thumbnail;

        saveMovies();

        renderMovies();

        updateAdminUI();

        editItemModal.classList.remove('active');

    });

    // Search functionality

    const searchInput = document.getElementById('searchInput');

    // Prevent download shortcuts

    document.addEventListener('keydown', (e) => {

        // Prevent Ctrl+S (save)

        if (e.ctrlKey && e.key === 's') {

            e.preventDefault();

            return false;

        }

    });

    // Nav filters

    const navHome = document.getElementById('navHome');

    const navMovies = document.getElementById('navMovies');

    const navSeries = document.getElementById('navSeries');

    const navMyList = document.getElementById('navMyList');

    function setActive(link){

        document.querySelectorAll('.nav-link').forEach(a=>a.classList.remove('active'));

        link.classList.add('active');

    }

    if (navHome) navHome.addEventListener('click', (e)=>{ e.preventDefault(); setActive(navHome); currentPath=[]; renderMovies(); updateAdminUI(); });

    if (navMovies) navMovies.addEventListener('click', (e)=>{ e.preventDefault(); setActive(navMovies); currentPath=[]; const onlyMovies = movies.filter(m=>m.type!=='folder'); renderMovies(onlyMovies); updateAdminUI(); });

    if (navSeries) navSeries.addEventListener('click', (e)=>{ e.preventDefault(); setActive(navSeries); currentPath=[]; const onlySeries = movies.filter(m=>m.type==='folder'); renderMovies(onlySeries); updateAdminUI(); });

    if (navMyList) navMyList.addEventListener('click', (e)=>{ e.preventDefault(); setActive(navMyList); currentPath=[]; renderMovies(getMyListItems()); updateAdminUI(); });

    // Hero navigation links (for mobile/tablet)

    const heroNavMovies = document.getElementById('heroNavMovies');

    const heroNavSeries = document.getElementById('heroNavSeries');

    const heroNavMyList = document.getElementById('heroNavMyList');

    if (heroNavMovies) heroNavMovies.addEventListener('click', (e)=>{ e.preventDefault(); currentPath=[]; const onlyMovies = movies.filter(m=>m.type!=='folder'); renderMovies(onlyMovies); updateAdminUI(); });

    if (heroNavSeries) heroNavSeries.addEventListener('click', (e)=>{ e.preventDefault(); currentPath=[]; const onlySeries = movies.filter(m=>m.type==='folder'); renderMovies(onlySeries); updateAdminUI(); });

    if (heroNavMyList) heroNavMyList.addEventListener('click', (e)=>{ e.preventDefault(); currentPath=[]; renderMovies(getMyListItems()); updateAdminUI(); });

}

// My List feature

function getMyList(){

    try { return JSON.parse(localStorage.getItem('barni4movies_mylist')||'[]'); } catch(_) { return []; }

}

function setMyList(ids){ localStorage.setItem('barni4movies_mylist', JSON.stringify(ids)); }

function toggleMyList(id){

    const ids = getMyList();

    const idx = ids.indexOf(id);

    if (idx>=0) ids.splice(idx,1); else ids.push(id);

    setMyList(ids);

    renderMovies();

}

function flattenAll(list){

    const out=[];

    for(const item of list){

        if(item.type==='folder'){

            out.push(item);

            if(item.children) out.push(...flattenAll(item.children));

            if(item.episodes) out.push(...item.episodes);

        } else out.push(item);

    }

    return out;

}

function getMyListItems(){

    const ids = getMyList();

    const all = flattenAll(movies);

    return all.filter(it=>ids.includes(it.id));

}

// Disable right-click on entire page

document.addEventListener('contextmenu', (e) => {

    if (e.target.tagName === 'VIDEO') {

        e.preventDefault();

        return false;

    }

});

